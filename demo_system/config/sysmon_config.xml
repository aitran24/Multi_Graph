<Sysmon schemaversion="4.90">
  <!-- 
  Sysmon Configuration for MultiKG Detection System
  Optimized for 10 ATT&CK Techniques
  -->
  
  <HashAlgorithms>md5,sha256</HashAlgorithms>
  <CheckRevocation/>
  
  <EventFiltering>
    
    <!-- Event ID 1: Process Create - LOG EVERYTHING FOR DETECTION -->
    <ProcessCreate onmatch="include">
      <!-- Include all processes - we need them for attack detection -->
      <Image condition="begin with">C:\</Image>
    </ProcessCreate>
    
    <!-- Event ID 3: Network Connection -->
    <NetworkConnect onmatch="include">
      <!-- Only log suspicious connections -->
      <DestinationPort condition="is">445</DestinationPort>
      <DestinationPort condition="is">3389</DestinationPort>
      <DestinationPort condition="is">5985</DestinationPort>
      <DestinationPort condition="is">135</DestinationPort>
    </NetworkConnect>
    
    <!-- Event ID 7: Image Load -->
    <ImageLoad onmatch="include">
      <!-- Track loading of suspicious DLLs -->
      <ImageLoaded condition="contains">comsvcs.dll</ImageLoaded>
      <ImageLoaded condition="contains">dbghelp.dll</ImageLoaded>
      <ImageLoaded condition="contains">samlib.dll</ImageLoaded>
    </ImageLoad>
    
    <!-- Event ID 8: CreateRemoteThread -->
    <CreateRemoteThread onmatch="include">
      <!-- All remote thread creation (process injection) -->
    </CreateRemoteThread>
    
    <!-- Event ID 10: ProcessAccess -->
    <ProcessAccess onmatch="include">
      <!-- Track access to sensitive processes -->
      <TargetImage condition="end with">lsass.exe</TargetImage>
      <TargetImage condition="end with">csrss.exe</TargetImage>
      <TargetImage condition="end with">winlogon.exe</TargetImage>
    </ProcessAccess>
    
    <!-- Event ID 11: File Create -->
    <FileCreate onmatch="exclude">
      <!-- Exclude temp files and prefetch -->
      <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
      <TargetFilename condition="contains">\Windows\Prefetch\</TargetFilename>
      <TargetFilename condition="end with">.tmp</TargetFilename>
      <TargetFilename condition="end with">.etl</TargetFilename>
      <TargetFilename condition="contains">PSScriptPolicyTest</TargetFilename>
    </FileCreate>
    
    <!-- Event ID 12: Registry Object Create/Delete -->
    <RegistryEvent onmatch="include">
      <!-- Track registry persistence locations -->
      <TargetObject condition="contains">CurrentVersion\Run</TargetObject>
      <TargetObject condition="contains">CurrentVersion\RunOnce</TargetObject>
      <TargetObject condition="contains">CurrentVersion\RunServices</TargetObject>
      <TargetObject condition="contains">CurrentVersion\Policies\Explorer\Run</TargetObject>
      <TargetObject condition="contains">CurrentVersion\Windows\Load</TargetObject>
      <TargetObject condition="contains">Winlogon\Shell</TargetObject>
      <TargetObject condition="contains">Winlogon\Userinit</TargetObject>
      <TargetObject condition="contains">SessionManager\BootExecute</TargetObject>
    </RegistryEvent>
    
    <!-- Event ID 13: Registry Value Set -->
    <RegistryEvent onmatch="include">
      <!-- Same as Event ID 12 -->
      <TargetObject condition="contains">CurrentVersion\Run</TargetObject>
      <TargetObject condition="contains">CurrentVersion\RunOnce</TargetObject>
      <TargetObject condition="contains">CurrentVersion\Policies\Explorer\Run</TargetObject>
    </RegistryEvent>
    
    <!-- Event ID 22: DNS Query -->
    <DnsQuery onmatch="exclude">
      <!-- Exclude common Microsoft domains -->
      <QueryName condition="end with">.microsoft.com</QueryName>
      <QueryName condition="end with">.windows.com</QueryName>
      <QueryName condition="end with">.bing.com</QueryName>
    </DnsQuery>
    
  </EventFiltering>
</Sysmon>
